(ns advent-of-code-2018.day-thirteen
  (:require [clojure.math.combinatorics :as combo]))

(def small-input ["/->-\\        ", "|   |  /----\\", "| /-+--+-\\  |", "| | |  | v  |", "\\-+-/  \\-+--/", "  \\------/   "])
(def input ["                                          /----------------------------------------------\\            /--------------------------\\                    ","                     /--------------------+----------------------------------------------+------\\     |                 /--------+-------------\\      ","                   /-+--------------------+----------------------\\                       |      | /---+-----------------+--------+----\\        |      ","                   | |                    |                      |               /-------+------+-+---+-----------------+--------+----+-\\      |      ","                   | |     /----------\\   |                      |/--------------+-------+------+-+---+-----------------+--------+\\   | |      |      ","                   | |     |          |   |                      ||  /-----------+------\\|      | |   |                 |        ||   | |      |      ","                   | |/----+----------+---+----------------------++--+-----------+------++--\\   | |   |  /-------------\\|        ||   | |      |      ","                   | ||    |          |   |                      ||  |/----------+------++--+---+-+---+--+-------------++-\\      ||   | |      |      ","                   | ||   /+----------+---+----------------------++--++-\\        |      ||  |   | |   |  |             || |      ||   | |      |      ","                   | ||   ||          |   |         /------------++--++-+--------+------++--+---+\\|   |  |             || |      ||   | |      |      ","                   | ||   ||          |   |         |            ||  || |        |      ||  |   |||   \\--+-------------++-+------/|   | |      |      ","                   | ||   ||          |  /+---------+------------++--++-+--------+------++--+---+++------+-------------++-+--\\    |   | |      |      ","                   | ||   ||         /+--++---------+------------++--++-+-----\\  |      ||  |   |||      |             || |  |    |   | |      |      ","                   | ||   ||         ||  ||         |            ||  || |     |  |      ||  |   |||      |             || |  |    |   | |      |      ","                  /+-++---++--\\  /---++--++-----\\   |            ||  || |     |  |      ||  |  /+++------+-----\\/------++-+--+----+---+-+------+--\\   ","    /-------------++-++---++--+--+--\\||  ||     |   |            ||  || |     |  |      ||  |  ||||      \\-----++------/| |  |    |   | |      |  |   ","    |             || ||/--++--+--+--+++--++-----+---+---\\        ||  || |     |  |      ||  |  ||||            ||       | |  |    |   | |      |  |   ","    |             || |||  |\\--+--+--++/  ||     |   |   |/-------++--++-+----\\|  |   /--++--+--++++------------++-------+-+--+--\\ |   |/+------+--+\\  ","    |             || |||  |   |  |  || /-++-----+---+\\  ||       ||  || |    ||  |   | /++--+--++++--\\         ||       | |  |  | |   |||      |  ||  ","    |            /++-+++--+\\  |  |  || | ||     |   ||  ||       ||  || |    ||  \\---+-+++--+--++++--+---------++-------+-+--+--+-+---++/      |  ||  ","    |     /------+++-+++--++--+--+--++-+-++-----+--\\||  ||  /----++--++-+----++------+-+++--+--++++--+---------++-------+-+--+--+-+---++------\\|  ||  ","    |     |      ||| |||  ||  |  |  || | ||/----+--+++--++--+----++--++-+----++------+-+++--+--++++--+---------++-------+-+--+--+-+---++-\\    ||  ||  ","    |     |      ||| |\\+--++--+--+--++-+-+++----+--+++--++--+----++--++-+----++------+-+++--/  ||||  |         ||       | |  |  | |   || |    ||  ||  ","    |     |      ||| | |  ||  |  \\--++-+-+++----/  |||  ||  |    ||  || |    ||      | |||     ||||  |         ||       | |  |  | |   || |    ||  ||  ","    |     |      ||| | |  ||/-+-----++-+-+++-------+++--++--+----++--++-+----++------+-+++-----++++--+---------++--->---+-+--+--+-+---++\\|    ||  ||  ","    |     |      ||| | |  ||| |     || | \\++-------+++--++--+----++--++-+----++------+-+++-----++++--+---------++-------+-+--/  | |   ||||    ||  ||  ","    |     |/-----+++-+-+--+++-+\\    || |  \\+-------+++--++--+----++--++-+----++------+-++/     ||||  |   /-----++------\\| |     | |   ||||    ||  ||  ","    |     ||     |||/+-+--+++-++----++-+---+-------+++--++--+----++--++-+----++------+-++------++++--+---+-----++------++-+---\\ | |   ||||    ||  ||  ","    |  /--++-----+++++-+-\\||| ||    || |   |       |\\+--++--+----++--++-+----++------+-++------++/^  |   |     ||      || |   | | |   ||||    ||  ||  ","    |  |  ||     ||||| | |||| ||    || |   |       | |  ||  |    ||  || |    ||      | ||  /---++-+--+---+-----++------++-+---+-+-+---++++\\   ||  ||  ","    |  |  ||     ||||| | |||| ||  /-++-+---+-------+-+--++--+----++--++-+----++------+-++--+---++-+--+---+-----++------++-+---+-+-+--\\|||||   ||  ||  ","    |  |  ||     ||||| | |||| ||  | || |   |       | |  ||  |    ||  || |    ||      | ||  |   || |  |   |     ||      || |   | | |  ||||||   ||  ||  ","    |  |  ||     ||||| |/++++-++--+-++-+---+\\      | |  ||  |  /-++--++-+----++------+-++--+---++-+--+---+-----++------++-+---+\\| |  ||\\+++---++--+/  ","    |  |  ||     ||||| |||||| ||  | || |   ||      | |  || /+--+-++--++-+----++------+-++--+---++-+--+---+-----++-\\    || |   ||| |  || |||   ||  |   ","    |  |  ||     ||||| |||||| ||  | || |   ||      | | /++-++--+-++--++-+----++------+-++--+---++-+--+-\\ |     || |    || |   ||| |  || |||   ||  |   ","    |  |  ||     ||||| |||||| ||  | || |   ||     /+-+-+++-++--+-++--++-+---\\||      | ||  |   || |  | | \\-----++-+----/| |/--+++-+--++-+++\\  ||  |   ","    |  |  ||     ||||| \\+++++-++--+-++-+---++-----++-+-+/| ||  | ||  || |   |||      | ||  |   || |  | |       || |     | ||  ||| |  || ||||  ||  |   ","    |  |  ||     |||||  ||||| ||  | || |   ||     || | | | ||  | ||  || |  /+++------+-++--+-\\ || |  | |       ^| |     | ||  ||| |  || ||||  ||  |   ","    |  | /++-----+++++--+++++-++--+-++-+---++-----++-+-+-+-++--+-++--++-+--++++------+-++--+-+-++-+--+-+\\      || |     | ||  ||| |  || ||||  ||  |   ","    |  | |||     |||||  ||||| ||  | || |   ||     || | | | ||  |/++--++-+--++++------+-++--+-+-++-+--+-++------++-+-\\   | ||  ||| |  || ||||  ||  |   ","   /+--+-+++-----+++++\\ ||||| ||  | || |/--++-----++-+-+-+-++--++++--++-+--++++------+-++--+-+-++-+--+-++-----\\|| | |   | ||  ||| |  || ||||  ||  |   ","   ||  | |||     |||||| ||||| ||  | || ||  ||     || | | | ||  |||| /++-+--++++------+-++--+-+-++-+--+-++---\\ ||| | |   | ||  ||| |  || ||||  ||  |   ","   ||  | |||     |||||| ||||| ||  | || ||  ||     ||/+-+-+-++--++++-+++-+--++++------+-++\\ | | \\+-+--+-++---+-+/| | |   | ||  ||| |  || ||||  ||  |   "," /-++--+-+++-----++++++-+++++-++--+-++-++--++-----++++-+-+-++--++++-+++-+--++++------+-+++-+-+\\ | |  | ||   | | \\-+-+---+-++--+++-+--++-++++--++--/   "," | ||  | |||     |||||| ||||| ||  | || ||  ||     |||| | | ||  |||| ||| |  ||||      | ||| | || | |  | ||   | |   | |   \\-++--+++-+--++-++++--+/      "," | ||  | |||     |||||| ||||| ||  | || ||  ||     |||| | | ||  |||| ||| | /++++------+-+++-+-++-+-+--+-++---+-+--\\| |     ||  ||| |  || ||||  |       "," | ||  | |||     |||||| ||||| ||  | || ||  \\+-----++++-+-+-++--++++-+++-+-+++++------+-+++-+-++-+-+--+-++---+-+--++-+-----++--+++-+--++-+/||  |       "," | ||  | |||     |||||| ||||| ||  | || ||   |/----++++-+-+-++--++++-+++-+-+++++------+-+++-+-++-+-+--+-++---+-+--++-+-----++--+++-+--++-+\\||  |       "," | ||  | |||     |||||| ||||| ||  | || ||   ||    |||| | | ||  |||| ||| | |||||      | ||| | || | \\--+-++---+-+--++-+-----++--+++-+--+/ ||||  |       "," | ||  | |||/----++++++-+++++-++--+-++-++---++----++++-+-+-++--++++-+++-+-+++++------+-+++-+-++-+----+-++\\  | |  || |     ||  ||| |  |  ||||  |       "," | ||  | ||||    \\+++++-+++/| ||  | || ||  /++----++++-+-+-++--++++-+++-+-+++++------+-+++-+-++-+----+-+++--+-+--++-+-----++--+++-+--+-\\||||  |       "," | ||  | ||||     ||||| ||| | ||  | || ||  |||    |||| | | ||  |||| \\++-+-+++++------+-+++-+-++-+----+-+++--/ |  || |     ||  ||| |  | |||||  |       "," | ||  | ||||     ||||| ||| | ||  | || ||  |||    |||| | | |\\--++++--++-+-+++++------+-+++-+-++-+----+-+++----+--++-+-----++--+++-+--+-+++++--/       "," | ||  | ||||     ||||| ||| | ||  | || ||  |||    |||| | | |   ||||  || | |||||      | ||| | || |    | |||    |  || |     ||  ||| |  | |||||          "," |/++--+-++++-----+++++-+++-+-++--+-++-++--+++----++++-+-+-+---++++--++-+-+++++------+-+++-+-++-+----+\\|||    |  || |     ||  ^v| |  | |||||          "," ||||  | ||||     ||||| ||| | ||  | || ||  |||    |||| \\-+-+---++++--++-+-+++++------+-+++-+-++-+----++/||    |  || |     ||  ||| |  | |||||          "," ||||  | ||||     ||||| ||| | ||  | |\\-++--+++----++++---+-+---++++--++-+-++++/      | ||| | || |    || ||    |  || |     ||  ||| |  | |||||          "," ||||  | ||||     ||||| ||| | ||  | |  ||  |||/---++++---+-+---++++--++-+-++++--\\    | ||| | || |    || ||    |  || |     ||  ||| |  | |||||          "," ||||  | ||||     ||||| ||| | ||  | |  \\+--++++---+++/   | |   ||||/-++-+-++++--+----+-+++-+-++-+\\   || ||    |  || |     ||  ||| |  | |||||          "," ||||  | ||||     ||||| ||| | ||  | |   |  ||||   |||    | |   ||||| || | ||||  | /--+-+++-+-++-++---++-++----+--++-+-----++-\\||| |  | |||||          "," ||||  | ||||     ||||| ||| | ||/-+-+---+--++++---+++----+-+---+++++-++-+-++++--+-+--+-+++-+-++-++--\\|| ||    |  || |     ||/++++-+--+-+++++------\\   "," ||||  | ||||     ||||| ||| | ||| | |   |  ||||   |||    | |   |\\+++-++-+-++++--+-+--+-+++-+-++-++--+++-++----+--++-/ /---+++++++-+--+\\|||||      |   "," ||||  | ||||     ||||| ||| | ||| | |   |  ||||   |||    | |   | ||| || | ||||  | |  | ||| | || ||  ||| ||    |  ||   |   ||||||| |  |||||||      |   "," ||||  | ||||     |||||/+++-+-+++-+-+---+--++++---+++----+-+---+-+++-++-+-++++--+-+--+-+++-+-++-++--+++-++----+--++---+--\\||||||| |  |||||||      |   "," ||||  | ||||     ||||||||| | ||| \\-+---+--++++---+++->--+-+->-+-+++-++-+-++++--+-+--+-+++-+-++-++--+++-++----+--++---+--++++++++-+--/||||||      |   "," ||||  | ||||     ||||||||| | |||   |   |  ||\\+---+++----+-+---+-+++-++-+-++++--+-+--+-+++-+-++-++--+++-++----+--++---+--++++++++-+---+++/||      |   "," ||||  | ||\\+-----+++++++++-+-+/|   |   |  || |   |||    | |   | ||| || | ||||  | |/-+-+++-+-++-++--+++-++----+--++\\  |  |||||||| |   ||| ||      |   "," ||||/-+-++-+-----+++++++++\\| | |  /+---+--++-+---+++----+-+---+-+++\\|| | ||||  | || | |||/+-++-++--+++-++-\\  |  |||  |  |||||||| |   ||| ||      |   "," ||||| | || |     |\\+++++++++-+-+--++---+--++-+---+++----+-+---+-/||||| | ||||  | || | ||||| || ||  ||| || |  |  |||  |  |||||||| |   ||| ||      |   "," ||||| | || |     | ||||||||| | |  ||   |  || |   |||    | |   |  \\++++-+-++++--+-++-+-+++++-++-++--+++-++-+--+--+++--+--++++++++-/   ||| ||      |   "," ||||| | |\\-+-----+-+++++++++-+-+--++---+--++-+---+/|    | |   |   |||| | ||||  | || | ||||| || ||  ||| || |  |  |||  \\--++++++++-----/|| ||      |   "," ||||| | |  |     | ||||||||| | |  ||   |  || | /-+-+----+-+---+---++++-+-++++--+-++-+-+++++-++-++--+++-++-+--+\\ |||     ||||||||      || ||      |   "," ||||| | |  |     | ||||||||| | |  ||   |  || | | | \\----+-+---+---++++-+-++++--+-++-+-++/|| || ||  ||| || |  || ||| /---++++++++------++-++\\     |   "," ||||| | |  |     | ||||||||| | |  ||   |  || | | |      | |   |   |||| | ||||/-+-++-+-++-++-++-++--+++-++-+--++-+++-+---++++++++------++-+++-\\   |   "," ||||| | |  |     | ||||||||| | |  ||   |  || |/+-+------+-+---+---++++-+-+++++\\| || | || || || ||  ||| || |  || ||| |   ||||||||      || ||| |   |   "," ||||| | |  |     |/+++++++++-+-+--++---+--++-+++-+------+-+---+---++++-+-+++++++-++-+<++\\|| || ||  ||| || |  || ||| |   ||||||||      || ||| |   |   "," |||\\+-+-+--+-----+++++++++++-+-+--+/   |  || ||| |      | |   |   |||| |/+++++++-++-+-+++++-++-++--+++-++-+--++-+++-+---++++++++-----\\|| ||| |   |   "," ||| | | |  |   /-+++++++++++-+-+--+----+--++-+++-+------+-+---+---++++-+++++++++-++-+-+++++-++-++--+++-++-+\\ || ||| |   ||||^|||     ||| ||| |   |   "," ||| | | |  |   | ||||||||||| | |  |    |  || ||| |      | |   |   |||| ||||||||| || | ||||| || || /+++-++-++-++-+++-+---++++++++---\\ ||| ||| |   |   "," ||| | | |  |   | ||||||||||| | |  |    |  || ||| |   /--+-+---+---++++-+++++++++-++-+-+++++-++-++-++++-++-++-++\\||| |   ||||||||   | ||| ||| |   |   "," ||| | | |  |   | ||||||||||| | |  |    |  || ||| |   |  | |   |   |||| ||||||||| || | |||\\+-++-++-++++-++-/| |||||| |   ||||||||   | ||| ||| |   |   "," ||| | | |  |   | ||||||||||| | |  |    |  || ||| |   |  | \\---+---++++-+++++++++-++-+-+++-+-++-++-++++-++--+-++++/| |   ||||||||   | ||| ||| |   |   "," ||| | | |  |   | ||||||||||| | |  |    |  \\+-+++-+---+--+-----+---++++-+++++++++-++-+-+++-+-++-++-++++-++--+-++++-+-+---++++++++---+-+/| ||| |   |   "," ||| | | |  |   | ||||||||||| | |  |/---+---+-+++-+---+--+-----+---++++-+++++++++-++-+-+++-+-++-++-++++-++--+-++++-+-+--\\||||||||   | | | ||| |   |   "," ||| | | |  |   |/+++++++++++-+-+--++---+---+-+++-+---+--+---\\ |   |||| ||||||||| || | ||| | || || |||| ||  | |||| | |  |||||||||   | | | v|| |   |   "," ||| | | |  |   |||v||||||\\++-+-+--++---+---+-+++-+---+--+---+-+---++++-/|||||||| \\+-+-+++-+-++-++-++++-++--+-++++-+-+--+++++/|||   | | | ||| |   |   "," ||| | | |  |   |||||||\\++-++-+-+--++---+---+-+++-+---+--+---+-+---++++--++++++++--+-+-+++-+-++-++-++++-++--+-++++-+-+--+/||| |||   | | | ||| |   |   ","/+++-+-+-+--+---+++++++-++-++-+-+--++---+---+-+++-+---+-\\|   | |   ||||  ||||||||  | \\-+++-+-++-++-++++-++--+-++++-+-+--+-+++-++/   | | | ||| |   |   ","|||| | | |  |   ||||||| || || | |  ||  /+---+-+++-+---+-++---+-+---++++--++++++++--+---+++-+-++-++-++++-++--+-++++-+-+--+-+++-++----+-+-+-+++\\|   |   ","|||| | | |  |   ||||||| || || | |  ||  ||   | \\++-+---+-++---+-+---++++--+++++++/  |   ||| | || || |||| ||  | |||| | |  | ||| ||    | | | |||||   |   ","|||| | | |  |/--+++++++-++-++-+-+--++--++---+--++-+---+-++---+-+---++++--+++++++---+---+++-+-++-++-++++-++--+-++++-+-+-\\| ||| ||    | | | |||||   |   ","|||| | |/+--++--+++++++-++-++-+-+--++--++---+--++-+---+-++\\  | |   ||||  |||||||   |   ||| | || || |||| ||  | |||| | | || ||| ||    | | | |||||   |   ","|||| | |||  ||  ||||||| || || | |/-++--++---+-\\|| |   | |||/-+-+---++++--+++++++---+---+++-+-++-++-++++-++--+-++++-+-+-++-+++-++---\\| | | |||||   |   ","|||| | |||  ||  ||||||| || || | || |\\--++---+-+++-+---+-++++-+-+---++++--+++++++---+---+++-+-++-++-++++-++--+-++++-+-+-+/ ||| ||   || | | |||||   |   ","|||| | |||  ||  ||||||| || || | || |   ||   | ||| |   | |||| | | /-++++--+++++++---+---+++-+-++-++-++++-++--+-++++-+-+-+\\ |\\+-++---++-+-+-+/|||   |   ","|||| | |||  ||  ||||||| || |\\-+-++-+---++---+-+++-+---+-++++-+-+-+-++++--+++++++---+---+++-+-++-++-++++-++--+-++++-+-+-++-+-+-++---++-+-/ | |||   |   ","|||| | |||  ||  ||||||| || |  | || |   ||   | ||| |   | |||| | | | ||||  |||||||   |   ||| | || || |||| ||  | |||| | | || | \\-++---++-+---+-+++---/   ","|||| | |||  ||  ||||||| || | /+-++-+---++---+-+++-+\\  | |||| | | | ||||  |||||||   |   ||| | || || |||| ||  | |||| | | || |   ||   || |   | |||       ","|||| | |||  ||  ||||||| || | || || |   || /-+-+++-++--+-++++-+-+-+-++++--+++++++---+---+++-+-++-++-++++-++--+-++++-+-+-++-+---++---++-+---+-+++-\\     ","|||| | |||  ||  ||||||| || | || || |   || |/+-+++-++--+-++++\\| | | ||\\+--+++++++---+---+/| | || || |||| ||  | |||| | | || |   ||   || |   | ||| |     ","|||| | |||  ||  ||||||| || | || || |   || ||| ||| ||  | |||||| | | || |  |||||||   |   | | | || || |||| ||  | |||| | | || |   ||   || |   | ||| |     ","|||| ^ |||  ||  ||||||| || | || || |   || ||| ||| ||  | |||||| | | \\+-+--+++++++---+---+-+-+-++-+/ \\+++-++--+-++++-+-+-++-+---++---+/ |   | ||| |     ","|||| | |||  ||  ||||||| || | || || |   || ||| ||| ||  | |||||| | |  | |  \\++++++---+---+-+-+-++-+---+++-++--+-++++-+-+-++-+---++---+--/   | ||| |     ","|||| | |||  ||  ||||||| || | || || |   || ||| ||\\-++--+-++++++-+-+--+-+---++++++---+---+-+-+-++-+---+++-++--+-+/|| | | || |   ||   |      | ||| |     ","|||| | |||  ||  |||||\\+-++-+-++-++-+---++-+++-++--++--+-++++++-+-+--+-+---++++++---+---+-+-+-++-/  /+++-++--+-+-++-+-+-++-+---++---+------+-+++-+--\\  ","|||| | |||  ||  ||||| | || | || || |   || ||| ||  ||  | |||||| | |  | |   ||||||   |   | | | ||    |||| ||  | | || | | || |   ||   |      | ||| |  |  ","|||| | ||v  ||  ||||| | || | || || |   || ||| ||  ||  | |||||| | |  | |   ||||||   |   | | | ||    |||| ||  | | || | | || |   ||   |      | ||| |  |  ","|||| | |||  ||  ||||| | \\+-+-++-++-+---++-++/ ||  ||  | |||||| | |  | |   ||||||   |   | | | ||    |||| ||  | | || | | || |   ||   |      | ||| |  |  ","|||| | ||| /++--+++++-+--+-+-++-++-+---++-++--++--++--+-++++++-+-+--+\\|   ||||||  /+---+-+-+-++----++++-++--+-+-++-+-+-++-+---++---+-\\    | ||| |  |  ","|||| | ||| |||  ||||| |  | | || || |   || ||  ||  ||  | |||||| | |  |||   |||||v  ||   | | | ||    |||| ||/-+-+-++-+-+-++-+---++---+-+----+-+++-+--+-\\","|||| | ||| |||  ||\\++-+--+-+-+/ || |   |\\-++--++--++--+-++++++-+-+--+++---++++++--++---+-+-+-++----++++-+++-+-/ || | | || |   ||   | |    | ||| |  | |","|||| | ||| |||  || || |  | | |  || |   |  ||  ||  \\+--+-++++++-+-+--+++---++/|||  ||   \\-+-+-++----++/| ||| |   || | | || |   ||   | |    | ||| |  | |","|||| | ||| |||  || || |  | | |  || |   |  ||  ||   |  | |||||| | |  |||   || |||  ||     | | ||    || | ||| |   ||/+-+-++-+---++\\  | |    | ||| |  | |","||\\+-+-+++-+++--++-++-+--+-+-+--++-+---+--++--++---+--+-++++++-+-+--+++---++-+++--++-----+-+-++----++-/ ||| |   |||| | || |   |||  | |    | ||| |  | |","|| | | ||| |||  || || |  | | |  || |   |  ||  ||   |  | |\\++++-+-+--+++---++-/||  ||     | | ||    ||   ||| |   |||| | |v | /-+++--+-+--\\ | ||| |  | |","|| | | ||| |||  || || |  | | |  || |   |  ||  ||   |  | | |||| | |  ||\\---++--++--++-----+-+-++----++---+++-+---++++-+-++-/ | |||  | |  | | ||| |  | |","|| | | ||| v\\+--++-++-+--+-+-+--++-+---+--++--++---+--+-+-++++-+-+--++----++--++--++-----+-+-++----++---+/| |   |||| | ||   | |||  | |  | | ||| |  | |","|| | | \\++-+-+--++-++-+--/ | |  || |   \\--++--++---+--+-+-++++-+-+--++----++--++--++-----+-+-++----++---+-+-+---++++-+-++---+-+++--+-+--+-+-+/| |  | |","|| | |  || | |  || || |/---+-+--++-+------++--++---+--+-+-++++-+-+-\\||    ||  ||  ||     | | ||    ||   | | |   |||| | ||   | |||/-+-+--+-+-+-+-+-\\| |","|| | |  || | |  || || ||   | \\--++-+------++--++---/  | | |||| | \\-+++----++--++--++-----+-+-++----++---+-+-+---++++-+-+/   | |||| | |  | | | | | || |","|| | |  || | |  || |\\-++---+----++-+------++--++------+-+-++++-+---+++----++--++--++-----+-+-++----++---+-+-+---++++-+-+----+-/||| | |  | | | | | || |","|| | |  || | |  || \\--++---+----++-+------++--++------+-+-++++-+---+++----++--++--++-----/ | ||    ||   | | |   |||| | |    |  ||| | |  | | | | | || |","|| | |  || | |  ||    ||   |    \\+-+------++--++------+-+-++++-+---+++----++--++--++-------+-++----+/   | | |   |||| | |    |  ||| | |  | | | | | || |","|| | |  || | |  ||    ||   |     | |      ||  ||      | | |\\++-+---+++----++--++--++-------+-++----+----+-+-+---++++-+-+----+--+++-/ |  | | | | | || |","|| | |  || | \\--++----++---+-----+-+------++--++------+-+-+-++-+---+++----++--++--++-------+-++----+----+-+-+---++++-+-/    |  |||   |  | | | | | || |","|| | |  || |    ||    ||   |     | |      ||  ||      | | | || |   |||    ||  ||  ||       \\-++----+----+-+-+---++++-+------+--+++---+--+-/ | | | || |","|| | |  \\+-+----++----++---+-----+-+------++--++------+-+-/ || |  /+++----++--++--++---------++----+-\\  | | |   |||| |      |  |||   |  |   | | | || |","|| | |   | |    ||    ||   |     | |      ||  ||      | |   || |  ||||    ||  ||  ||         ||    | |  | | |   |||| \\------+--+++---+--+---/ | | || |","|| | |   | |    ||    |\\---+-----+-+------++--++------+-+---++-+--+/||    ||  \\+--++---------++----+-+--+-+-+---++++--------+--+++---+--+-----/ | || |","|| | |   | |    ||    |  /-+-----+-+------++--++------+-+---++-+--+-++---\\||   |  \\+---------++----+-+--+-+-+---++++--------+--+++---/  |       | || |","|| | |   | |    ||    |  | |     | |      ||  ||      | |   || |  | ||   |||   |   |         ||    | |  | | |   ||||        |  ||\\------+-------+-/| |","|| | |   | |    ||    |  | |     | |      \\+--++------+-+---++-+--+-++---+++---+---+---------++----+-+--+-+-+---++++--------+--++-------+-------/  | |","|| | |   | |    ||    |  | |     | |       |  ||      | |   || |  | ||   |||   |   \\---------++----+-+--+-+-+---+++/        |  ||       |          | |","|| | |   | \\----++----+--+-+-----+-+-------+--++------+-+---++-+--+-+/   |||   |             ||    \\-+--+-+-+---+++---------+--++-------+----------/ |","|| | |   |      ||    |  | |     | |       |  ||      | |   || |  |/+----+++-\\ |             ||      |  | | |   |||         |  ||       |            |","|| | |   |      ||    |  | |     | |       |  ||      | |   || |  \\++----+++-+-+-------------++------/  | | |   |||         |  ||       |            |","|| | |   |      ||    |  | |     | |       \\--++------+-+---/| \\---++----+++-+-+-------------++---------+-+-+---+++---------+--/|       |            |","|| | |   |      ||    |  | |     \\-+----------/|      | |    |     ||    ||\\-+-+-------------/|         | | |   |||         |   |       |            |","|| | \\---+------++----+--+-/       |           |      | |    |     ||    ||  | |              |         | \\-+---+++---------+---+-------+------------/","|| |     |      |\\----+--+---------+-----------+------+-+----/     ||    ||  | |              |         |   |   |||         \\---+-------/             ","\\+-+-----+------+-----+--+---------+-----------+------+-/          ||    |\\--+-+--------------+---------+---+---+/|             |                     "," | |     \\------+-----+--+---------+-----------+------+------------++----+---+-+--------------+---------/   |   | |             |                     "," | |            |     |  |         |           \\------+------------++----+---+-/              |             |   | \\-------------/                     "," | |            \\-----+--+---------+------------------+------------++----+---+----------------+-------------/   |                                     "," | |                  |  \\---------+------------------+------------++----/   |                |                 |                                     "," | \\------------------/            |                  |            ||        |                |                 |                                     "," \\---------------------------------+------------------+------------++--------+------------->--/                 |                                     ","                                   |                  |            \\+--------/                                  |                                     ","                                   |                  \\-------------+-------------------------------------------/                                     ","                                   \\--------------------------------/                                                                                 "])
(def test-track ["/-\\","v v","\\-/"])
(def figure-eight ["/>\\  ","| |  ","\\-+-\\","  | |","  \\>/"])

(def east-west "-")
(def north-south "|")
(def inter "+")
(def ne-sw "/")
(def nw-se "\\")
(def cart-west "<")
(def cart-east ">")
(def cart-north "^")
(def cart-south "v")

(defn map-to-keyword [char]
  (case char
    " " nil
    "-" :ew
    "|" :ns
    "+" :inter
    "/" :ne-sw
    "\\" :nw-se
    "<" :ew
    ">" :ew
    "^" :ns
    "v" :ns))

(defn build-row [row row-num]
  (into {} (for [idx (range 0 (count row))]
             (let [char (str (nth row idx))
                   mapping (map-to-keyword char)]
               (if (nil? mapping)
                 {}
                 (assoc {} [idx row-num] mapping))))))

(defn process-track [track-strings process-fn]
  (for [row-num (range 0 (count track-strings))]
    (let [row (nth track-strings row-num)]
      (process-fn row row-num))))

(defn mapify-track [track-strings]
  (into (sorted-map) (process-track track-strings build-row)))

(defn build-car [char x y]
  (let [location [x y]
        turns 0]
    (case char
      "<" {:direction :west :location location :turn-count turns}
      ">" {:direction :east :location location :turn-count turns}
      "^" {:direction :north :location location :turn-count turns}
      "v" {:direction :south :location location :turn-count turns}
      {})))

(defn find-cars [row row-num]
  (remove empty? (for [x (range 0 (count row))]
                   (let [char (str (nth row x))
                         car (build-car char x row-num)]
                     car))))

(defn get-cars [track-strings]
  (flatten (remove empty? (process-track track-strings find-cars))))

(defn turn-left [current-direction]
  (case current-direction
    :north :west
    :south :east
    :east :north
    :west :south))

(defn turn-right [current-direction]
  (case current-direction
    :north :east
    :south :west
    :east :south
    :west :north))

(defn handle-ne-sw [car]
  (case (:direction car)
    (:north :south) (turn-right (:direction car))
    (:east :west) (turn-left (:direction car))))

(defn handle-nw-se [car]
  (case (:direction car)
    (:north :south) (turn-left (:direction car))
    (:east :west) (turn-right (:direction car))))

(defn handle-intersection [car]
  (let [current-dir (:direction car)
        turn-modulo (mod (:turn-count car) 3)]
    (case turn-modulo
      0 (turn-left current-dir)
      1 current-dir
      2 (turn-right current-dir))))

(defn handle-straightaway [car]
  (:direction car))

(defn get-new-direction [segment-type car]
  (case segment-type
    :inter (handle-intersection car)
    (:ew :ns) (handle-straightaway car)
    :ne-sw (handle-ne-sw car)
    :nw-se (handle-nw-se car)))

(defn get-new-turn-count [segment-type current-turn-count]
  (if (= segment-type :inter)
    (inc current-turn-count)
    current-turn-count))

(defn get-new-location [direction current-location]
  (let [x (nth current-location 0)
        y (nth current-location 1)]
    (case direction
      :north [x (dec y)]
      :south [x (inc y)]
      :east [(inc x) y]
      :west [(dec x) y])))

(defn tick-car [track car]
  (let [segment-type (get track (:location car))
        new-direction (get-new-direction segment-type car)
        new-turns (get-new-turn-count segment-type (:turn-count car))
        new-location (get-new-location new-direction (:location car))]
    {:direction new-direction :location new-location :turn-count new-turns}))

(defn tick [{:keys [track cars]}]
  {:track track :cars (map #(tick-car track %) cars)})

(defn detect-collision [pair]
  (let [location-a (:location (nth pair 0))
        location-b (:location (nth pair 1))]
    (if (= location-a location-b)
      location-a
      nil)))

(defn detect-collisions [{:keys [cars]}]
  (let [pairs (combo/combinations cars 2)]
    (remove nil? (map detect-collision pairs))))